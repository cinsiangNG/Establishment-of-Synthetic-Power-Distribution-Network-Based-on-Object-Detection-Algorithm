# -*- coding: utf-8 -*-
"""Data_fusion

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1cxC51TWAsjBiRh8QjO0L32Q2KRQRh0b2
"""

!pip install openpyxl
!pip install geopy
!pip install plotly
!pip install sktlearn

"""## **Link to GOOGLE CLOUD**"""

from google.colab import drive
drive.mount('/content/drive')

import os
os.environ["DATASET_DIRECTORY"] = "/content/drive/MyDrive/é»ƒä¿Šç¿”_è«–æ–‡ç ”ç©¶ğŸ“š/Aerial_view"

"""# **Reading an excel file**"""

import pandas as pd

# è¯»å– CSV æ–‡ä»¶
satellite_data = pd.read_excel('/content/detected_poles_newdataset_11x.xlsx')
street_view_data = pd.read_excel('/content/AllPredictions.xlsx')

"""# **Concat data and get the center of each aggregation**"""

import numpy as np
from sklearn.cluster import DBSCAN

all_poles = pd.concat([satellite_data, street_view_data], ignore_index=True)

# 3. æ•°æ®èåˆ
# ä½¿ç”¨ DBSCAN èšç±»ç®—æ³•æ¥èåˆç›¸è¿‘çš„ç‚¹
coords = all_poles[['Lat', 'Lon']].values
print(np.argwhere(np.isnan(coords)))
epsilon = 0.0001  # çº¦ 11 ç±³ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´
min_samples = 1  # æ¯ä¸ªèšç±»è‡³å°‘åŒ…å« 1 ä¸ªæ ·æœ¬
db = DBSCAN(eps=epsilon, min_samples=min_samples).fit(coords)

# ä¸ºæ¯ä¸ªç‚¹æ·»åŠ èšç±»æ ‡ç­¾
all_poles['Cluster'] = db.labels_

# è®¡ç®—æ¯ä¸ªèšç±»çš„ä¸­å¿ƒç‚¹
fused_poles = all_poles.groupby('Cluster').agg({
    'Lat': 'mean',
    'Lon': 'mean'
}).reset_index()

"""# **Plot them and data visualization**"""

import plotly.graph_objects as go

def plot_poles(data, name, color):
    return go.Scattermapbox(
        lat=data['Lat'],
        lon=data['Lon'],
        mode='markers',
        marker=dict(size=8, color=color),
        name=name
    )

fig = go.Figure()

fig.add_trace(plot_poles(satellite_data, 'Satellite', 'blue'))
fig.add_trace(plot_poles(street_view_data, 'Street View', 'green'))
fig.add_trace(plot_poles(fused_poles, 'Fused', 'red'))

fig.update_layout(
    mapbox=dict(
        style="open-street-map",
        center=dict(lat=fused_poles['Lat'].mean(), lon=fused_poles['Lon'].mean()),
        zoom=14
    ),
    showlegend=True,
    height=800,
    title_text="Pole Detection Data Fusion"
)

fig.show()

"""# **Save the result**"""

fusion_T = pd.DataFrame(fused_poles,columns=['Lat','Lon'])
fusion_T.to_excel("/content/" + '/drive/MyDrive/é»ƒä¿Šç¿”_è«–æ–‡ç ”ç©¶ğŸ“š/' + 'fused_poles_newdataset_Yolo11x+OriginalStreetview.xlsx', index = False)

print(fusion_T)

"""# **Compare the result with the actual prediction**"""

def reset_and_create_new_figure():
    """
    é‡ç½®å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ Plotly å›¾å½¢å¯¹è±¡
    """
    # åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç™½å›¾å½¢
    fig = go.Figure()

    # è®¾ç½®åŸºæœ¬å¸ƒå±€
    fig.update_layout(
        mapbox_style="open-street-map",
        height=800
    )

    return fig

fig = reset_and_create_new_figure()

WHPoleLoc = pd.read_excel('/content/' + "PoleLocationGT.xlsx",sheet_name='pole') # actual pole locations
import plotly.graph_objects as go
import pandas as pd

def plot_poles(data, name, color, size=10):
    return go.Scattermapbox(
        lat=data['Lat'],
        lon=data['Lon'],
        mode='markers',
        marker=dict(size=size, color=color),
        name=name
    )

# è¯»å– Excel æ–‡ä»¶ä¸­çš„å®é™…æ†ä½ç½®
actual_poles = pd.read_excel('/content/PoleLocationGT.xlsx', sheet_name='pole')
actual_poles.columns = ['Lat', 'Lon']  # ç¡®ä¿åˆ—åä¸€è‡´

# åˆ›å»ºå›¾å½¢
fig = go.Figure()

# æ·»åŠ å„ç±»æ•°æ®ç‚¹
fig.add_trace(plot_poles(fused_poles, 'Fused', 'red', size=8))
fig.add_trace(plot_poles(actual_poles, 'Actual', 'yellow', size=6))  # å®é™…ç‚¹ç¨å¤§ä¸€äº›ä»¥ä¾¿åŒºåˆ†

# æ›´æ–°å¸ƒå±€
fig.update_layout(
    mapbox=dict(
        style="open-street-map",
        center=dict(lat=fused_poles['Lat'].mean(), lon=fused_poles['Lon'].mean()),
        zoom=14
    ),
    showlegend=True,
    height=800,
    title_text="Pole Detection Data Fusion and Comparison"
)

fig.show()