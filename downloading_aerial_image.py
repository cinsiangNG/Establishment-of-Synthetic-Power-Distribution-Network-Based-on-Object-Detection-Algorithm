# -*- coding: utf-8 -*-
"""Downloading_Aerial_image.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1HiwAKZh9ES91tzgCiMiSfaq2COU6PizS
"""

! git clone https://github.com/doersino/aerialbot
! python3 -m venv aerialbot
! cd aerialbot
! source bin/activate
! pip3 install -r /content/aerialbot/requirements.txt

! python3 /content/aerialbot/aerialbot.py --help

! python3 /content/aerialbot/aerialbot.py /content/aerialbot/config.sample.ini -p29.18943033,-94.98234459	 --image_width 1000 --image_height 1000 -w 35 -h 35
# image_path_template = "/content/aerialbot/aerialbot-{latitude}-{longitude}-{width}-{height}-{max_meters_per_pixel}.jpg"
# image_path_template = "/content/drive/MyDrive/é»ƒä¿Šç¿”_è«–æ–‡ç ”ç©¶ğŸ“š/Aerial_view/Junior_project/{latitude}-{longitude}-{width}-{height}-{max_meters_per_pixel}.jpg"

! python3 /content/aerialbot/aerialbot.py /content/aerialbot/config.sample.ini -p29.19172943,-94.97851689 --image_width 1000 --image_height 1000 -w 60 -h 60

import cv2
from google.colab.patches import cv2_imshow

# è¯»å–å›¾åƒ
image = cv2.imread('/content/aerialbot/aerialbot-38.90207751--76.92485159-30.0-30.0-0.03.jpg')

# å®šä¹‰å·¦ä¸Šå’Œå³ä¸‹ç‚¹çš„åæ ‡
point1 = (250, 0)  # å·¦ä¸Šè§’ç‚¹çš„åæ ‡ (x1, y1)
point2 = (600, 600)  # å³ä¸‹è§’ç‚¹çš„åæ ‡ (x2, y2)

# åœ¨å›¾åƒä¸Šç»˜åˆ¶è¾¹ç•Œæ¡†
color = (0, 255, 0)  # BGRé¢œè‰²ï¼Œè¿™é‡Œæ˜¯ç»¿è‰²
thickness = 2  # çº¿æ¡å®½åº¦
image_with_bbox = cv2.rectangle(image, point1, point2, color, thickness)

# æ˜¾ç¤ºå¸¦æœ‰è¾¹ç•Œæ¡†çš„å›¾åƒ
cv2_imshow(image_with_bbox)
cv2.waitKey(0)
cv2.destroyAllWindows()

import pandas as pd
import subprocess

# è®€å– CSV æ–‡ä»¶
df = pd.read_excel('/content/Utility_Poles.xlsx')

# å®šç¾©ä¸‹è¼‰åœ°åœ–çš„å‡½æ•¸
def download_map(latitude, longitude, image_width=1000, image_height=1000, width=35, height=35):
    command = [
        'python3', '/content/aerialbot/aerialbot.py',
        '/content/aerialbot/config.sample.ini',
        f'-p{latitude},{longitude}',
        f'--image_width', str(image_width),
        f'--image_height', str(image_height),
        f'-w', str(width),
        f'-h', str(height)
    ]
    subprocess.run(command)

# éæ­·æ¯ä¸€è¡Œï¼Œä¸¦å°æ¯å€‹åæ¨™åŸ·è¡Œä¸‹è¼‰æ“ä½œ
for index, row in df.iterrows():
    x = row['X']
    y = row['Y']
    print(f"Downloading map for coordinates: ({y}, {x})")
    download_map(latitude=y, longitude=x)

import pandas as pd
import subprocess
import matplotlib.pyplot as plt
import cv2
from google.colab.patches import cv2_imshow

# è¯»å– CSV æ–‡ä»¶
df = pd.read_csv('/content/Utility_Poles.csv')

# å®šä¹‰ä¸‹è½½åœ°å›¾çš„å‡½æ•°
def download_map(latitude, longitude, image_width=1000, image_height=1000, width=30, height=30):
    command = [
        'python3', '/content/aerialbot/aerialbot.py',
        '/content/aerialbot/config.sample.ini',
        f'-p {latitude}', f'{longitude}',
        f'--image_width', str(image_width),
        f'--image_height', str(image_height),
        f'-w', str(width),
        f'-h', str(height)
    ]
    subprocess.run(command)

# åˆå§‹åŒ–ä¸€ä¸ªæ–°åˆ—æ¥å­˜å‚¨æ£€æµ‹ç»“æœ
df['Detection'] = ''

for index, row in df.iterrows():
    latitude = row['Y']
    longitude = row['X']

    print(f"Downloading map for coordinates: ({latitude}, {longitude})")
    download_map(latitude, longitude)

    # ç”Ÿæˆä¸‹è½½å›¾ç‰‡çš„è·¯å¾„
    image_path = f"/content/aerialbot/aerialbot-{latitude}-{longitude}-60.0-60.0-0.03.jpg"

    # ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹æ£€æµ‹æ˜¯å¦æœ‰ç”µçº¿æ†
    results = model(image_path)

    # æ£€æŸ¥æ˜¯å¦æœ‰æ£€æµ‹ç»“æœ
    if results:
        df.at[index, 'Detection'] = 'âœ”'
    else:
        df.at[index, 'Detection'] = 'x'

    # æ˜¾ç¤ºå¸¦æœ‰è¾¹ç•Œæ¡†çš„ç»“æœå›¾åƒï¼ˆå¯é€‰ï¼‰
    result_image = results[0].plot()
    plt.imshow(cv2.cvtColor(result_image, cv2.COLOR_BGR2RGB))
    plt.axis('off')
    plt.show()

# ä¿å­˜æ–°çš„ Excel æ–‡ä»¶
df.to_excel('/Result.xlsx', index=False)

from google.colab import drive
drive.mount('/content/drive')

import pandas as pd

# è®€å– CSV æ–‡ä»¶
df = pd.read_excel('/content/Utility_Poles.xlsx')

# éš¨æ©Ÿé¸æ“‡ 2000 å€‹å”¯ä¸€çš„åæ¨™
selected_coordinates = df.sample(n=2000, replace=False, random_state=42)

import subprocess
import random
import os
from math import sin, cos, radians, degrees, atan2, asin, atan

n=0

# å®šç¾©ä¸‹è¼‰åœ°åœ–çš„å‡½æ•¸
def download_map(latitude, longitude):
    command = [
        'python3', '/content/aerialbot/aerialbot.py',
        '/content/aerialbot/config.sample.ini',
        f'-p{latitude},{longitude}',
        '--image_width', '1000',
        '--image_height', '1000',
        '-w', '35',
        '-h', '35'
    ]
    subprocess.run(command, check=True)

# è¨ˆç®—æ–°åæ¨™çš„å‡½æ•¸
def calculate_new_coordinates(lat, lon, distance):
    R = 6371000  # åœ°çƒåŠå¾‘ï¼ˆç±³ï¼‰

    # éš¨æ©Ÿé¸æ“‡ä¸€å€‹æ–¹å‘ï¼ˆ0-360åº¦ï¼‰
    bearing = radians(random.uniform(0, 360))

    # å°‡è·é›¢è½‰æ›ç‚ºå¼§åº¦
    angular_distance = distance / R

    lat1 = radians(lat)
    lon1 = radians(lon)

    lat2 = asin(sin(lat1) * cos(angular_distance) +
                cos(lat1) * sin(angular_distance) * cos(bearing))

    lon2 = lon1 + atan2(sin(bearing) * sin(angular_distance) * cos(lat1),
                        cos(angular_distance) - sin(lat1) * sin(lat2))

    return degrees(lat2), degrees(lon2)

# éæ­·é¸ä¸­çš„åæ¨™ï¼Œä¸¦å°æ¯å€‹åæ¨™åŸ·è¡Œä¸‹è¼‰æ“ä½œ
for index, row in selected_coordinates[832:].iterrows():
    x = row['X']
    y = row['Y']

    # ç”Ÿæˆ 5 åˆ° 10 ç±³ä¹‹é–“çš„éš¨æ©Ÿè·é›¢
    distance = random.uniform(5, 10)

    # è¨ˆç®—æ–°çš„åæ¨™
    new_y, new_x = calculate_new_coordinates(y, x, distance)
    download_map(latitude=new_y, longitude=new_x)
    n += 1
    print(n)